<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vimeo Embeds</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css">
    <style>
      textarea {
        font-family: monospace;
        font-size: small;
      }
    </style>
  </head>
  <body>
    <header></header>
    <main>
      <h1>Vimeo Embeds</h1>
      <p>Generate Vimeo embed code to work on <a href="https://openvisualizationacademy.beehiiv.com/">OVA’s Beehiiv</a> (web & email), with clickable thumbnails as fallback.</p>

      <form id="form">
        <label>
          <span>Paste <strong>Vimeo embed</strong> code provided by Vimeo’s sharing feature:</span>
          <textarea name="original" id="original" placeholder='<div style="padding:…' rows="5" required></textarea>
        </label>
        <label>
          <span>Paste <strong>Beehiiv post</strong> link (web version that runs JS and video):</span>
          <input name="link" id="link" placeholder="https://openvisualizationacademy.beehiiv.com/p/…">
        </label>

        <button>Convert to Beehiiv</button>
      </form>

      <br><br>
      <hr>

      <p>Converted code (to embed Vimeo video on Beehiiv posts) will be generated and pasted here:</p>
      <textarea name="custom" id="custom" placeholder="…" rows="10"></textarea>
      <button disabled id="copy">Copy to clipboard</button>

    </main>

    <footer>
      <small>
        Created (quickly) by <a href="https://vsueiro.com">Vinicius Sueiro</a> for the <a href="https://openvisualizationacademy.org">Open Visualization Academy</a>
      </small>
    </footer>

    <script>

      // Define 16:9 aspect ratio as percentage for padding hack
      const aspectRatio = (9 / 16 * 100).toFixed(2);

      // Fill value of orignal form, in case users just want to change the id
      original.value = `<div style="padding:${ aspectRatio }% 0 0 0;position:relative;"><iframe src="https://player.vimeo.com/video/1137428663?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" frameborder="0" allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share" referrerpolicy="strict-origin-when-cross-origin" style="position:absolute;top:0;left:0;width:100%;height:100%;" title="Video"></iframe></div><script src="https://player.vimeo.com/api/player.js">\</script\>`;  

      // Call validation function when form is submitted
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        validateForm();
      });

      // Get HTML nodes from string
      function html(string) {
        // Create a DocumentFragment
        const fragment = document.createRange().createContextualFragment(string);

        // // If it has a single child element, return it
        // if (fragment.childElementCount === 1) {
        //   return fragment.firstElementChild;
        // }

        // Wrap all children in an anchor tag and return them
        const a = document.createElement("a");
        a.append(...fragment.children);
        return a;
      }

      // Inject custom elements and attributes to make it Beehiiv friendly
      async function customize(elements) {

        // Get video ID
        const id = elements.querySelector("iframe").src.match(/\/video\/(\d+)/)?.[1];

        console.log(id);

        // Define href
        let href = `https://vimeo.com/${ id }`;
        
        // Prioritize using Beehiiv post URL, instead of Vimeo URL directly
        if (link && link.value.startsWith("http")) {
          href = link.value;
        }

        // If wrapper element is an <a> tag
        if (elements.tagName === "A") {
          // Set anchor href
          elements.href = href;

          // Allow children element to fit full width
          elements.style.display = "block";
        } else {
          alert("Could not create link");
          return false;
        }

        // Get video thumbnail (using a 3rd party service)
        let thumbnail = `https://vumbnail.com/${ id }.jpg`

        // Prioritize extracting absolute URL from http://vimeo.com/api/v2/video/${ id }.json
        try {
          const response = await fetch(`http://vimeo.com/api/v2/video/${ id }.json`);
          const data = await response.json();
          thumbnail = data[0].thumbnail_large;
        } catch (error) {
          console.error(error);
        }

        // Get styled div
        const div = elements.querySelector("div[style]");

        // Define play button as inline SVG
        // const playButton = `url('data:image/svg+xml,%3Csvg width=%22960%22 xmlns=%22http://www.w3.org/2000/svg%22 height=%22540%22 viewBox=%220 0 960 540%22 fill=%22none%22%3E%3Cpath d=%22M459.623046875,240.1474609375C458.0234375,239.19921875,456,240.3525390625,456,242.2119140625L456,297.7880859375C456,299.6474609375,458.0234375,300.80078125,459.623046875,299.8525390625L506.515625,272.064453125C508.083984375,271.134765625,508.083984375,268.865234375,506.515625,267.935546875L459.623046875,240.1474609375Z%22 fill=%22%23fff%22 stroke-width=%224%22 stroke=%22%23ddd%22/%3E%3C/svg%3E')`;

        // Define play button as inline PNG (vector seems to be removed from email)
        const playButton = `url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA8AAAAIcCAMAAAAOgzdJAAAAe1BMVEUAAADd3d3d3d3d3d3d3d3h4eHd3d3c3Nze3t7d3d3d3d3b29vd3d3e3t7d3d3b29ve3t7d3d3c3Nzd3d3e3t7d3d3d3d3e3t7c3Nzd3d3e3t7c3Nzc3Nzf39/////d3d329vbu7u76+vro6Ojf39/k5OTh4eH8/Pzx8fEDhrZiAAAAHnRSTlMA5qH+XwXYIQr59RXukUgcvLMOyoF3bzYrzcaxOii17cBqAAAEMUlEQVR42uzBgQAAAACAoP2pF6kCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGD24EAAAAAAAMj/tRFUVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVYU9OBAAAAAAAPJ/bQRVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWHfXnASiKEwjBZQkYdCfBuVIoi4/xXKXGEShw3MTc7Zw5f+aVoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+mX2cV2AlMbLUZ0MFwXIZzGojenjZQGyGdajq9sCJNMcwF81vI0LkMqo1rr6+Ut4+uA2C1KpB6vV/rOGwUUB8oiADza7GpYvBcgiAg7r79qY3NwVIIcI+MiOhmQi4JPNtob75wIk0Ab8b0ePhrMC9F4bcGdHz588zYLeawM+29Gv7wXotwi4Y72zoyGFCLjr9DRr7osD9FoEfG6/9cUBftm7l5UGgigIoHmAYlAkggtfXIT8/zfaumgXMRlm5S045x8Kipmu7v5mgC/06DqaOEBbM8Dn5sRBj4amrgR4TBz0aGhtBliPhjwzwNd79N2DqTD0sxBgU2HobCHApsLQ2UKATYWhs4UAmwpDZwsBNhWGzhYCbCoMnS0E2FQYOpsBXtOjXz2lBC3MAK/q0TeOdUAH6wI8fJ5q8DUaOpgBXtejdxvg/wkwBFOhIZiPWBDMbyQI5iAHBHOUEoIZM0Awc0IIZtAPwVypA8FcagfBXCsLwVzsDsE8rQLBPG4GwTwvCsE88A3BarjYnu+ftWforIbz9my2ABFq+Hu28PK+AXqrwegXQtVg9AuhajD6hVA1GP1CqBqMfiFUDUa/EKoGo18Ita+q39mC0S9E2VbVqX68mS1AmF2V2QKketzWt4PZAiS6Pe7rsPPYEYR6+vDtCgAAAAAAAAAAAAAAAADgiz04EAAAAAAA8n9tBFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVYQ8OBAAAAACA/F8bQVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV2IMDAQAAAAAg/9dGUFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVWV9uCABAAAAEDQ/9ftCFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgK8ATIT2RBaaFSgAAAAASUVORK5CYII=')`;

        // Add video thumbnail as a background image
        div.style.backgroundImage = `${ playButton }, url(${ thumbnail })`;
        div.style.backgroundSize = "cover";
        div.style.backgroundPosition = "center";

        // Insert script that removed href attribute from a tag (so link does not exist on web post, only email client)
        const script = document.createElement("script");
        script.textContent = `document.currentScript.closest('a').removeAttribute('href');`;
        elements.prepend(script);

        // Paste custom code into target textarea
        custom.value = elements.outerHTML;

        // Enable copy button
        copy.disabled = false;
      }

      // Copy textearea#custom value to clipboard
      function copyToClipboard() {
        // Gathers the desired text
        const text = custom.value;

        // Tries to copy to clipboard
        navigator.clipboard.writeText(text).then(
          (success) => {
            
            // Changes text
            copy.textContent = "Copied";
            copy.disabled = true;

            // Reverts changes after 2s
            setTimeout(() => {
              copy.disabled = false;
              copy.textContent = "Copy to clipboard";
            }, 1000);
          },
          (error) => {
            // Changes text
            copy.textContent = "Error";
            copy.disabled = True;
          }
        );
      }

      // Trigger copy function when copy button is clicked
      copy.addEventListener("click", copyToClipboard)

      // Check if original textarea contains the necessary structure
      function validateForm() {
        const elements = html(original.value);

        console.log(elements);
        console.log(elements.outerHTML);

        // Check if original embed code contains a Vimeo iframe
        if (!elements.querySelector('iframe[src^="https://player.vimeo.com/"]')) {
          alert("Could not find vimeo iframe");
          return false;
        }

        // TODO: Add more validation
        
        customize(elements);
      }
    </script>
  </body>
</html>